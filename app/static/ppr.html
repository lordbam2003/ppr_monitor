<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPR Management - Sistema de Monitoreo PPR</title>
    <!-- Bootstrap 5 CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="/static/css/sweetalert2.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                Monitor PPR
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-table me-1"></i> PPRs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/users"><i class="fas fa-users me-1"></i> Usuarios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports"><i class="fas fa-chart-bar me-1"></i> Reportes</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/login"><i class="fas fa-user-circle me-1"></i> Iniciar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-table me-2"></i>Gestión de PPRs</h1>
            <div>
                <button class="btn btn-primary me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                </button>
                <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-file-upload me-1"></i>Subir PPR
                </button>
                <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#uploadCeplanModal">
                    <i class="fas fa-file-invoice me-1"></i>Subir CEPLAN
                </button>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#uploadCarteraModal">
                    <i class="fas fa-folder-open me-1"></i>Subir Cartera
                </button>
            </div>
        </div>

        <!-- Tab navigation -->
        <ul class="nav nav-tabs mb-4" id="pprTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pprs-tab" data-bs-toggle="tab" data-bs-target="#pprs" type="button" role="tab">PPRs</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ceplan-tab" data-bs-toggle="tab" data-bs-target="#ceplan" type="button" role="tab">CEPLAN</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cartera-tab" data-bs-toggle="tab" data-bs-target="#cartera" type="button" role="tab">Cartera</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="pprTabContent">
            <!-- PPRs Tab -->
            <div class="tab-pane fade show active" id="pprs" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Programas Presupuestales (PPRs)</h5>
                        <div>
                            <button class="btn btn-primary" id="refreshPprBtn">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="pprTable">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Año</th>
                                        <th>Estado</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="pprTableBody">
                                    <!-- Data will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CEPLAN Tab -->
            <div class="tab-pane fade" id="ceplan" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>CEPLAN</h5>
                        <div>
                            <button class="btn btn-primary" id="refreshCeplanBtn">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="ceplanLoading" class="text-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando CEPLAN...</span>
                            </div>
                            <p class="mt-2">Cargando datos CEPLAN...</p>
                        </div>
                        <div id="ceplanData" class="table-responsive" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Cartera Tab -->
            <div class="tab-pane fade" id="cartera" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Cartera de Servicios</h5>
                        <div>
                            <button class="btn btn-primary" id="refreshCarteraBtn">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="carteraLoading" class="text-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando Cartera...</span>
                            </div>
                            <p class="mt-2">Cargando datos de Cartera de Servicios...</p>
                        </div>
                        <div id="carteraData" class="table-responsive" style="display: none;"></div>
                        <nav aria-label="Cartera de Servicios Pagination">
                            <ul class="pagination justify-content-center" id="carteraPagination">
                                <!-- Pagination will be loaded dynamically -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Subir Archivo PPR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="pprFile" class="form-label">Seleccionar archivo PPR</label>
                            <input type="file" class="form-control" id="pprFile" accept=".xlsx,.xls" required>
                            <div class="form-text">Formato permitido: Excel (.xlsx, .xls). Tamaño máximo: 100MB</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="uploadBtn">Subir Archivo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload CEPLAN Modal -->
    <div class="modal fade" id="uploadCeplanModal" tabindex="-1" aria-labelledby="uploadCeplanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadCeplanModalLabel">Subir Archivo CEPLAN</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadCeplanForm">
                        <div class="mb-3">
                            <label for="ceplanFile" class="form-label">Seleccionar archivo CEPLAN</label>
                            <input type="file" class="form-control" id="ceplanFile" accept=".xlsx,.xls" required>
                            <div class="form-text">Formato permitido: Excel (.xlsx, .xls). Tamaño máximo: 100MB</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="uploadCeplanBtn">Subir Archivo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">Detalle del PPR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="pprDetailContent">
                        <!-- PPR detail content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Sistema de Monitoreo PPR</h5>
                    <p>Plataforma para el seguimiento de Programas Presupuestales (PPR) y CEPLAN</p>
                </div>
                <div class="col-md-6">
                    <h5>Contacto</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-envelope me-2"></i> soporte@monitorppr.com</li>
                        <li><i class="fas fa-phone me-2"></i> +57 123 456 7890</li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <small>&copy; 2023 Sistema de Monitoreo PPR. Todos los derechos reservados.</small>
            </div>
        </div>
    </footer>

    <!-- Responsibles Modal -->
    <div class="modal fade" id="responsiblesModal" tabindex="-1" aria-labelledby="responsiblesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="responsiblesModalLabel">Gestionar Responsables</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="currentPprId">
                    <div id="responsiblesModalContent">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Cartera Modal -->
    <div class="modal fade" id="uploadCarteraModal" tabindex="-1" aria-labelledby="uploadCarteraModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadCarteraModalLabel">Subir Cartera de Servicios</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadCarteraForm">
                        <div class="mb-3">
                            <label for="carteraFile" class="form-label">Seleccionar archivo de Cartera de Servicios</label>
                            <input type="file" class="form-control" id="carteraFile" accept=".xlsx,.xls" required>
                            <div class="form-text">Formato permitido: Excel (.xlsx, .xls). Tamaño máximo: 50MB</div>
                        </div>
                        <div class="mb-3">
                            <p class="mb-1"><strong>Formato esperado:</strong></p>
                            <ul class="mb-0">
                                <li>Columnas requeridas: Programa, Producto, Actividad, Sub Producto, Trazador, Unidad de Medida</li>
                                <li>El campo Programa contiene código y nombre (ej: "0002 SALUD MATERNO NEONATAL")</li>
                                <li>Cada campo debe contener código y nombre separados por espacio</li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="uploadCarteraBtn">Subir Archivo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="/static/js/sweetalert2.min.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
        // PPR Management specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize authentication
            initializeAuth();
            
            loadPPRs();
            
            // Initialize tab event listeners
            initializeTabEventListeners();
            
            // Check for preferred tab from transversal_data page
            const preferredTab = localStorage.getItem('preferredTab');
            if (preferredTab) {
                localStorage.removeItem('preferredTab'); // Clear the preference after use
                showTab(preferredTab);
            }
            
            // Event listeners for PPRs tab
            document.getElementById('refreshPprBtn').addEventListener('click', loadPPRs);
            document.getElementById('uploadBtn').addEventListener('click', uploadPPRFile);
            document.getElementById('uploadCeplanBtn').addEventListener('click', uploadCeplanFile);
            document.getElementById('uploadCarteraBtn').addEventListener('click', uploadCarteraFile);
            
            // Add event listeners for the main refresh and upload buttons
            document.getElementById('refreshBtn').addEventListener('click', function() {
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab.id === 'pprs') {
                    loadPPRs();
                } else if (activeTab.id === 'ceplan') {
                    loadCEPLANData();
                } else if (activeTab.id === 'cartera') {
                    loadCarteraData();
                }
            });
        });

        function showTab(tabName) {
            // Remove 'active' class from all tabs and content panes
            document.querySelectorAll('.nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active', 'show');
            });
            
            // Add 'active' to the requested tab and content pane
            const tabBtn = document.getElementById(`${tabName}-tab`);
            const tabPane = document.getElementById(tabName);
            
            if (tabBtn && tabPane) {
                tabBtn.classList.add('active');
                tabPane.classList.add('active', 'show');
                
                // Trigger the shown event to load content if needed
                if (!tabBtn.dataset.loaded) {
                    if (tabName === 'ceplan') {
                        loadCEPLANData();
                        tabBtn.dataset.loaded = 'true';
                    } else if (tabName === 'cartera') {
                        loadCarteraData();
                        tabBtn.dataset.loaded = 'true';
                    }
                }
            }
        }

        function initializeTabEventListeners() {
            // Tab events for lazy loading
            document.getElementById('pprs-tab').addEventListener('shown.bs.tab', function () {
                // PPRs are already loaded by default
            });

            document.getElementById('ceplan-tab').addEventListener('shown.bs.tab', function () {
                if (!this.dataset.loaded) {
                    loadCEPLANData();
                    this.dataset.loaded = 'true';
                }
            });

            document.getElementById('cartera-tab').addEventListener('shown.bs.tab', function () {
                if (!this.dataset.loaded) {
                    loadCarteraData();
                    this.dataset.loaded = 'true';
                }
            });
            
            // Additional refresh buttons for other tabs
            document.getElementById('refreshCeplanBtn').addEventListener('click', function() {
                loadCEPLANData();
            });
            
            document.getElementById('refreshCarteraBtn').addEventListener('click', function() {
                loadCarteraData();
            });
        }

        async function loadPPRs() {
            try {
                const response = await callAPI('/pprs', 'GET');
                const tbody = document.getElementById('pprTableBody');
                tbody.innerHTML = '';
                
                if (response && response.data) {
                    response.data.forEach(ppr => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ppr.codigo_ppr}</td>
                            <td>${ppr.nombre_ppr}</td>
                            <td>${ppr.anio}</td>
                            <td><span class=\"badge bg-${ppr.estado === 'activo' ? 'success' : 'secondary'}\">${ppr.estado}</span></td>
                            <td>${new Date(ppr.fecha_creacion).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info me-1" onclick="manageResponsibles(${ppr.id_ppr}, '${ppr.nombre_ppr}')" title="Gestionar Responsables">
                                    <i class="fas fa-user-cog"></i>
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="viewPPR(${ppr.id_ppr})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="editPPR(${ppr.id_ppr})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePPR(${ppr.id_ppr}, '${ppr.nombre_ppr}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading PPRs:', error);
                showError('Error al cargar los PPRs');
            }
        }

        async function loadCarteraData() {
            try {
                document.getElementById('carteraLoading').style.display = 'block';
                document.getElementById('carteraData').style.display = 'none';

                const response = await callAPI('/cartera', 'GET');
                
                if (response && response.data && response.data.length > 0) {
                    displayCarteraData(response.data);
                } else {
                    document.getElementById('carteraLoading').innerHTML = '<div class="alert alert-info text-center">No hay datos de Cartera de Servicios cargados.</div>';
                }
            } catch (error) {
                console.error('Error loading Cartera data:', error);
                document.getElementById('carteraLoading').innerHTML = `<div class="alert alert-danger text-center">Error al cargar datos de Cartera: ${error.message}</div>`;
            }
        }

        // Pagination variables
        let carteraData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        function displayCarteraData(data) {
            carteraData = data;
            currentPage = 1;
            renderCarteraTable();
        }
        
        function renderCarteraTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = carteraData.slice(startIndex, endIndex);
            
            let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Programa Código</th>
                            <th>Programa Nombre</th>
                            <th>Producto Código</th>
                            <th>Producto Nombre</th>
                            <th>Actividad Código</th>
                            <th>Actividad Nombre</th>
                            <th>Sub Producto Código</th>
                            <th>Sub Producto Nombre</th>
                            <th>Trazador</th>
                            <th>Unidad Medida</th>
                        </tr>
                    </thead>
                    <tbody>`;

            pageData.forEach(item => {
                html += `<tr>
                    <td>${item.id || ''}</td>
                    <td><strong>${item.programa_codigo || ''}</strong></td>
                    <td>${item.programa_nombre || ''}</td>
                    <td><strong>${item.producto_codigo || ''}</strong></td>
                    <td>${item.producto_nombre || ''}</td>
                    <td><strong>${item.actividad_codigo || ''}</strong></td>
                    <td>${item.actividad_nombre || ''}</td>
                    <td><strong>${item.sub_producto_codigo || ''}</strong></td>
                    <td>${item.sub_producto_nombre || ''}</td>
                    <td class="text-center"><span class="badge bg-${item.trazador === 'X' ? 'success' : 'secondary'}">${item.trazador || ''}</span></td>
                    <td>${item.unidad_medida || ''}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('carteraData').innerHTML = html;
            document.getElementById('carteraLoading').style.display = 'none';
            document.getElementById('carteraData').style.display = 'block';
            
            renderCarteraPagination();
        }
        
        function renderCarteraPagination() {
            const totalPages = Math.ceil(carteraData.length / itemsPerPage);
            const paginationElement = document.getElementById('carteraPagination');
            
            if (totalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changeCarteraPage(${currentPage - 1})">Anterior</a>
            </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeCarteraPage(${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHtml += `<li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>`;
                }
            }
            
            // Next button
            paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changeCarteraPage(${currentPage + 1})">Siguiente</a>
            </li>`;
            
            paginationElement.innerHTML = paginationHtml;
        }
        
        function changeCarteraPage(page) {
            if (page < 1 || page > Math.ceil(carteraData.length / itemsPerPage) || page === currentPage) {
                return;
            }
            
            currentPage = page;
            renderCarteraTable();
        }

        async function loadCEPLANData() {
            try {
                document.getElementById('ceplanLoading').style.display = 'block';
                document.getElementById('ceplanData').style.display = 'none';

                // For now, we'll display a message since we don't have an endpoint to get all CEPLAN data
                // In the future, you could create an endpoint that returns all CEPLAN data
                document.getElementById('ceplanLoading').innerHTML = `
                    <div class="alert alert-info text-center">
                        <p>La visualización de todos los datos CEPLAN no está implementada aún.</p>
                        <p>Los datos CEPLAN se visualizan actualmente en la vista detallada de cada PPR.</p>
                    </div>`;
            } catch (error) {
                console.error('Error loading CEPLAN data:', error);
                document.getElementById('ceplanLoading').innerHTML = `<div class="alert alert-danger text-center">Error al cargar datos CEPLAN: ${error.message}</div>`;
            }
        }

        async function uploadPPRFile() {
            const fileInput = document.getElementById('pprFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Por favor seleccione un archivo');
                return;
            }

            try {
                showLoading('Subiendo y procesando archivo...');
                const result = await callAPIWithFile('/upload/ppr', file);
                
                if (result && result.preview_id) {
                    showSuccess('Archivo subido y procesado exitosamente. Redirigiendo a la vista previa...');
                    
                    document.getElementById('uploadModal').querySelector('.btn-close').click();
                    document.getElementById('uploadForm').reset();
                    
                    setTimeout(() => {
                        window.location.href = `/preview?id=${result.preview_id}`;
                    }, 1500);
                } else {
                    showSuccess('Archivo subido exitosamente');
                    document.getElementById('uploadModal').querySelector('.btn-close').click();
                    document.getElementById('uploadForm').reset();
                    loadPPRs(); // Refresh PPRs after upload
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                hideLoading();
            }
        }

        async function uploadCeplanFile() {
            const fileInput = document.getElementById('ceplanFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Por favor seleccione un archivo');
                return;
            }

            try {
                showLoading('Subiendo y procesando archivo CEPLAN...');
                const result = await callAPIWithFile('/upload/ceplan', file);
                
                if (result && result.preview_id) {
                    showSuccess('Archivo CEPLAN subido y procesado exitosamente. Redirigiendo a la vista previa...');
                    
                    document.getElementById('uploadCeplanModal').querySelector('.btn-close').click();
                    document.getElementById('uploadCeplanForm').reset();
                    
                    setTimeout(() => {
                        window.location.href = `/preview?id=${result.preview_id}`;
                    }, 1500);
                } else {
                    showError('No se pudo obtener una vista previa para el archivo CEPLAN.');
                    hideLoading();
                }
            } catch (error) {
                console.error('Error uploading CEPLAN file:', error);
                hideLoading();
            }
        }

        async function uploadCarteraFile() {
            const fileInput = document.getElementById('carteraFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Por favor seleccione un archivo');
                return;
            }

            try {
                showLoading('Subiendo y procesando Cartera de Servicios...');
                const result = await callAPIWithFile('/cartera', file);
                
                if (result && result.preview_id) {
                    showSuccess('Cartera de Servicios subida y procesada exitosamente. Redirigiendo a la vista previa...');
                    
                    document.getElementById('uploadCarteraModal').querySelector('.btn-close').click();
                    document.getElementById('uploadCarteraForm').reset();
                    
                    setTimeout(() => {
                        // Redirect to preview page with the preview_id
                        window.location.href = `/preview?id=${result.preview_id}&type=cartera`;
                    }, 1500);
                } else {
                    showSuccess('Cartera de Servicios subida exitosamente');
                    document.getElementById('uploadCarteraModal').querySelector('.btn-close').click();
                    document.getElementById('uploadCarteraForm').reset();
                    // Refresh the data after upload if on the Cartera tab
                    if (document.querySelector('#cartera.tab-pane.active')) {
                        loadCarteraData();
                    }
                }
            } catch (error) {
                console.error('Error uploading Cartera file:', error);
                hideLoading();
            }
        }

        function viewPPR(pprId) {
            window.location.href = `/ppr_detalle?id=${pprId}`;
        }

        function editPPR(pprId) {
            Swal.fire({
                title: 'Editar PPR',
                html: `<p>Funcionalidad de edición no implementada aún.</p>`,
                icon: 'info',
            });
        }

        function deletePPR(pprId, pprName) {
            Swal.fire({
                title: '¿Está seguro?',
                text: `El PPR "${pprName}" será eliminado permanentemente.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await callAPI(`/pprs/${pprId}`, 'DELETE');
                        showSuccess('PPR eliminado exitosamente');
                        loadPPRs();
                    } catch (error) {
                        console.error('Error deleting PPR:', error);
                    }
                }
            });
        }

        // --- Responsibles Management --- 

        async function manageResponsibles(pprId, pprName) {
            const modal = new bootstrap.Modal(document.getElementById('responsiblesModal'));
            document.getElementById('responsiblesModalLabel').textContent = `Gestionar Responsables para: ${pprName}`;
            document.getElementById('currentPprId').value = pprId;
            const contentDiv = document.getElementById('responsiblesModalContent');
            contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            modal.show();

            try {
                const [assigned, available] = await Promise.all([
                    callAPI(`/asignaciones/ppr/${pprId}/responsables`, 'GET'),
                    callAPI('/asignaciones/responsables', 'GET')
                ]);

                const assignedIds = new Set(assigned.map(u => u.id_usuario));
                const availableUsers = available.filter(u => !assignedIds.has(u.id_usuario));

                let html = '<div class="row">'
                // Assigned Users Column
                html += '<div class="col-md-6"><h5>Asignados</h5><ul class="list-group">'
                if (assigned.length > 0) {
                    assigned.forEach(user => {
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">${user.nombre} <button class="btn btn-sm btn-danger" onclick="unassignUser(${pprId}, ${user.id_usuario})"><i class="fas fa-times"></i></button></li>`;
                    });
                } else {
                    html += '<li class="list-group-item text-muted">No hay responsables asignados.</li>';
                }
                html += '</ul></div>';

                // Available Users Column
                html += '<div class="col-md-6"><h5>Disponibles</h5><ul class="list-group">'
                if (availableUsers.length > 0) {
                    availableUsers.forEach(user => {
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">${user.nombre} <button class="btn btn-sm btn-success" onclick="assignUser(${pprId}, ${user.id_usuario})"><i class="fas fa-plus"></i></button></li>`;
                    });
                } else {
                    html += '<li class="list-group-item text-muted">No hay responsables disponibles para asignar.</li>';
                }
                html += '</ul></div>';

                html += '</div>';
                contentDiv.innerHTML = html;

            } catch (error) {
                console.error("Error loading responsibles:", error);
                contentDiv.innerHTML = '<div class="alert alert-danger">Error al cargar los datos.</div>';
            }
        }

        async function assignUser(pprId, userId) {
            try {
                await callAPI(`/asignaciones/ppr/${pprId}/responsables/${userId}`, 'POST');
                showSuccess('Responsable asignado.');
                const pprName = document.getElementById('responsiblesModalLabel').textContent.replace('Gestionar Responsables para: ', '');
                manageResponsibles(pprId, pprName); // Refresh modal content
            } catch (error) {
                console.error("Error assigning user:", error);
            }
        }

        async function unassignUser(pprId, userId) {
            try {
                await callAPI(`/asignaciones/ppr/${pprId}/responsables/${userId}`, 'DELETE');
                showSuccess('Responsable desasignado.');
                const pprName = document.getElementById('responsiblesModalLabel').textContent.replace('Gestionar Responsables para: ', '');
                manageResponsibles(pprId, pprName); // Refresh modal content
            } catch (error) {
                console.error("Error unassigning user:", error);
            }
        }

    </script>
</body>
</html>